var gameport=process.env.PORT||27025,http=require("http"),path=require("path"),url=require("url"),fs=require("fs"),server=http.createServer(app),app=http.createServer(function(e,t){var n=url.parse(e.url).pathname,r=path.join(process.cwd()+"/pub/",n);path.exists(r,function(e){if(!e){t.writeHead(404,{"Content-Type":"text/plain"});t.write("404 Not Found\n"+r);t.end();return}if(fs.statSync(r).isDirectory())r+="/index.html";fs.readFile(r,"binary",function(e,n){if(e){t.writeHead(500,{"Content-Type":"text/plain"});t.write(e+"\n");t.end();return}t.writeHead(200);t.write(n,"binary");t.end()})})}).listen(gameport),io=require("socket.io").listen(app);var Boxie=require("./pub/boxie.js");Server={getPlayerList:function(e){var t={};for(var n in e.objects){if(!e.objects)continue;if(e.objects[n].settings.dead==1&&e.objects[n].settings.type==2){delete e.objects[n];continue}var r=e.objects[n];t[e.objects[n].id]={pos:r.pos,settings:r.settings}}return t},getNumberOfPlayers:function(e){var t=0;for(var n in e){t++}return t},_colors:[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[0,255,255],[255,0,255]],generateColor:function(e){return Server._colors[e%Server._colors.length]},sendPlayerList:function(e){io.sockets.emit("pl",Server.getPlayerList(e))},printMap:function(e){console.log("Map:");for(var t=0;t<e.world.length;t++){var n="";for(var r=0;r<e.world[t].length;r++){n+=e.world[t][r].type}console.log(n)}},getSpawnPos:function(e){var t=0,n=false,r,i;while(!n){r=Math.floor(Math.random()*e.world.length);i=Math.floor(Math.random()*e.world[r].length);if(e.world[r][i].type==0||t>200)n=[r,i]}return n},powers:[{name:"Scramble!",F:function(e){e.buildWorld([e.world.length,e.world[0].length],.4,0)}}],mapsize:[50,50],mappoints:.1,powerInterval:1e4};var game=new Boxie.Game;game.buildWorld([Server.mapsize[0],Server.mapsize[1]],.4,Server.mappoints);var numberOfPlayers=0;game.svars.pwrtime=0;game.svars.pwrto=false;game.listen("ptouch",function(e){console.log("ptouch");io.sockets.emit("pn",e);if(game.svars.pwrtime+Server.powerInterval<(new Date).getTime()){var t=game.countFreePoints();if(10<Server.mapsize[0]*Server.mapsize[1]*Server.mappoints-t){console.log("POWER!",Server.mapsize[0]*Server.mapsize[1]*Server.mappoints-t);var n=0,r;for(var i in this.objects){if(!this.objects[i]||this.objects[i].settings.type==2)continue;if(this.objects[i].settings.points>n){n=this.objects[i].settings.points;r=this.objects[i]}}var s=Server.powers[Math.floor(Math.random()*Server.powers.length)];console.log(s);r.so.emit("pwr",s.name);game.svars.pwr=s;game.svars.pwrto=r}}});io.configure(function(){io.set("log level",0);io.set("authorization",function(e,t){t(null,true)})});io.sockets.on("connection",function(e){e.emit("OK");console.log("New dude");e.on("activate",function(t){console.log("activate",t);var n=t.name.replace(["<",">"],["<","&gt"]);var r=e.player=new Boxie.Man(false,{color:Server.generateColor(numberOfPlayers),name:n,points:0});r.pos=Server.getSpawnPos(game);game.addObject(r);r.so=e;r.listen("drag",function(t){console.log("drag");e.broadcast.emit("swapb",{a:t.a,b:t.b})});r.listen("push",function(e){io.sockets.emit("swapb",{a:e.a,b:e.b});console.log("push")});r.listen("die",function(t){r.settings.points=0;e.broadcast.emit("die",{id:r.id,reason:t});e.emit("die",{id:r.id,reason:t})});numberOfPlayers++;e.emit("self",{id:r.id,pos:r.pos,settings:r.settings});e.emit("game",{world:game.world});e.broadcast.emit("");e.on("move",function(t){r.move(t.pos,t.push);e.broadcast.emit("pp",{id:r.id,pos:r.pos});e.emit("move",r.pos)});e.on("respawn",function(e){r.pos=Server.getSpawnPos(game);r.settings.dead=0;io.sockets.emit("respawn",{id:r.id,pos:r.pos})});e.on("pwr",function(){console.log("pwr",game.svars.pwrto.id,r.id);if(game.svars.pwrtime+Server.powerInterval<(new Date).getTime()&&game.svars.pwrto.id==r.id){io.sockets.emit("rotate");game.svars.pwrtime=(new Date).getTime();setTimeout(function(){game.svars.pwr.F(game);io.sockets.emit("game",{world:game.world});Server.sendPlayerList(game)},1500)}});e.on("game",function(){e.emit("game",{world:game.world})});e.on("hash",function(){e.emit("hash",game.hash())});e.on("objects",function(){Server.sendPlayerList(game)});Server.sendPlayerList(game);e.on("disconnect",function(){delete game.objects[r.id];console.log("DELETED",r.id);console.log("PLayers right now: "+Server.getNumberOfPlayers());Server.sendPlayerList(game)});e.on("admin",function(e){console.log("admin command:",e);if(typeof e.act==undefined){return false}if(e.act=="newmap"){game.buildWorld([10,10]);io.sockets.emit("game",{world:game.world})}else if(e.act=="col"){if(typeof e.target!="undefined"&&typeof game.objects[e.target]!="undefined"&&typeof e.col=="object"){game.objects[e.target].settings.color=e.col;Server.sendPlayerList(game)}else{return false}}})});console.log("PLayers right now: "+Server.getNumberOfPlayers())})
