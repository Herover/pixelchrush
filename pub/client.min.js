function addMessage(e,t){var n=d.createElement("li");n.appendChild(n.ownerd.createTextNode(e));n.style.setProperty("color",t);e_messages.insertBefore(n,e_messages.firstChild)}function setupconnection(e){so=io.connect();so.send("connection");if(e_game.requestFullscreen)e_game.requestFullscreen();if(e_game.mozRequestFullScreen)e_game.mozRequestFullScreen();if(e_game.webkitRequestFullscreen)e_game.webkitRequestFullscreen();so.on("OK",function(t){console.log("got OK");so.emit("activate",{name:e});so.on("self",function(e){console.log("Got self, working...");player=new Boxie.Man(e.id,e.settings);player.pos=e.pos;game.addObject(player);e_myname.innerHTML=e.settings.name;var t=e.settings.color;e_myname.style.setProperty("color","rgb("+t[0]+","+t[1]+","+t[2]+")");var n=true;player.listen("move",function(e){so.emit("move",e);net_confirm++});so.on("move",function(e){if(net_confirm>5){player.pos=e;net_confirm=0;console.log("CONFIRM 5!");so.emit("game");so.emit("objects")}else net_confirm--;if(net_confirm==0){player.pos=e;so.emit("hash")}console.log("confirm",net_confirm)});player.listen("die",function(e){so.emit("respawn")});so.on("game",function(e){console.log("Got game, working");game.world=e.world});so.on("hash",function(e){console.log("hash",game.hash(),e);if(game.hash()!=e){so.emit("game");so.emit("objects");console.log("data mishmatch")}});so.on("pl",function(e){console.log("Got playerlist, working");for(var t in e){if(typeof game.objects[t]=="undefined"){var n;if(e[t].settings.type==1){n=new Boxie.Man(t,e[t].settings);var r=n.settings.color;addMessage(n.settings.name+" joined ","rgb("+r[0]+","+r[1]+","+r[2]+")")}else if(e[t].settings.type==2)n=new Boxie.Point(t,e[t].settings);console.log(t,n.settings,e[t].settings);game.addObject(n);n.pos=e[t].pos}else{game.objects[t].settings=e[t].settings}}for(var i in game.objects){if(typeof e[game.objects[i].id]=="undefined"){console.log("deleting",game.objects[i].id);delete game.objects[game.objects[i].id]}}});so.on("pp",function(e){console.log(e,game.objects[e.id].pos);game.objects[e.id].pos=e.pos});so.on("pn",function(e){console.log(e);game.objects[e.t].settings.points=e.value;delete game.objects[e.p]});so.on("swapb",function(e){player.boxie.move(e.a,e.b)});so.on("die",function(e){game.objects[e.id].die(e.reason);console.log(e.id,"was killed by",e.reason.player);var t=game.objects[e.id].settings.color;addMessage(game.objects[e.id].settings.name+" was killed by "+game.objects[e.reason.player].settings.name,"rgb("+t[0]+","+t[1]+","+t[2]+")")});so.on("respawn",function(e){console.log("Respawning...");game.objects[e.id].pos=e.pos;game.objects[e.id].settings.dead=0});so.on("pwr",function(e){e_power.removeAttribute("hidden");e_powerstr.innerHTML=e});so.on("rotate",function(){game.can_rotate_to+=Math.PI*2});w.addEventListener("keydown",function(e){e.preventDefault();switch(e.which){case 87:player.move([0,-1],n);break;case 38:player.move([0,-1],n);break;case 65:player.move([-1,0],n);break;case 37:player.move([-1,0],n);break;case 83:player.move([0,1],n);break;case 40:player.move([0,1],n);break;case 68:player.move([1,0],n);break;case 39:player.move([1,0],n);break;case 32:n=2;break;case 70:e_power.setAttribute("hidden","hidden");if(player.settings.pwr!=""){so.emit("pwr")};default:console.log(e.which)}});w.onkeyup=function(e){switch(e.keyCode){case 32:n=true;default:}};d.body.addEventListener("touchstart",function(e){e.preventDefault();starttouch=e.changedTouches[0];console.log("touchdown");touch_e=e;if(Math.abs(e.changedTouches[0].pageX-game.settings.screen[0]/2)<game.settings.width&&Math.abs(e.changedTouches[0].pageY-game.settings.screen[1]/2)<game.settings.width){e_power.setAttribute("hidden","hidden");if(player.settings.pwr!=""){so.emit("pwr")}}});d.body.addEventListener("touchend",function(e){e.preventDefault();touch_e=false});d.body.addEventListener("touchmove",function(e){e.preventDefault();touch_e=e;touchhandle(e)})})})}function touchhandle(){if(!touch_e)return 0;var e=(new Date).getTime();if(touch_last_ime+50<e){touch_last_ime=(new Date).getTime();var t=game.settings.screen[0]/2,n=game.settings.screen[1]/2,r=touch_e.changedTouches[0].pageX,i=touch_e.changedTouches[0].pageY,s;if(Math.abs(r-t)>Math.abs(i-n)){s=r<game.settings.width||r>game.settings.screen[0]-game.settings.width?2:true;if(r<t)player.move([-1,0],s);else player.move([1,0],s)}else{s=i<game.settings.width||i>game.settings.screen[1]-game.settings.width?2:true;if(i<n)player.move([0,-1],s);else player.move([0,1],s)}console.log(r,i,t,n)}}function update(){w.requestAnimFrame(function(){game.draw();touchhandle();update()},canvas)}function sc_hidescreens(){var e=d.getElementsByClassName("sc");for(var t=0;t<e.length;t++){e[t].setAttribute("hidden","hidden")}}function sc_showscreen(e){var t=d.getElementsByClassName("sc");for(var n=0;n<t.length;n++){if(t[n].id==e){t[n].removeAttribute("hidden");console.log(t[n].id,"screen is showed")}else{t[n].setAttribute("hidden","hidden");console.log(n,"is not the right screen")}}}function sc_startgame(){console.log("starting");sc_hidescreens();setupconnection(d.getElementById("e_name").value)}function sc_showhelp(){sc_hidescreens();sc_showscreen("sc_help")}function sc_showmenu(){sc_showscreen("sc_startgame")}function onResize(){game.settings.screen[0]=noise.width=canvas.width=w.innerWidth;game.settings.screen[1]=noise.height=canvas.height=w.innerHeight}var d=document,w=window,canvas=d.getElementById("can"),noise=d.getElementById("noise"),e_myname=d.getElementById("myname"),e_messages=d.getElementById("messages"),e_power=d.getElementById("g_power"),e_powerstr=d.getElementById("g_power_str"),e_game=d.getElementById("game"),touchstart,touch_last_ime=0,touch_e=false;net_confirm=0;w.requestAnimFrame=function(){return w.requestAnimationFrame||w.webkitRequestAnimationFrame||w.mozRequestAnimationFrame||function(e){w.setTimeout(e,1e3/60)}}();var game=new Boxie.Game;game.setCanvas(canvas,noise);sc_hidescreens();sc_showscreen("sc_startgame");w.addEventListener("resize",onResize);onResize();update()
